<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Gestión de Órdenes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="h4 mb-3">Panel de Órdenes</h1>
    <div id="adminInfo" class="alert alert-warning small">
      Debes iniciar sesión como administrador para continuar.
      <button id="btnLogin" class="btn btn-sm btn-primary ms-2">Iniciar con Google</button>
    </div>

    <div class="d-flex gap-2 mb-3">
      <a href="index.html" class="btn btn-outline-secondary btn-sm">Inicio</a>
      <button id="btnReload" class="btn btn-outline-primary btn-sm d-none">Recargar</button>
      <button id="btnLogout" class="btn btn-outline-danger btn-sm d-none">Cerrar sesión</button>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Orden</th>
            <th>Usuario</th>
            <th>Curso</th>
            <th>Monto</th>
            <th>Comprobante</th>
            <th>Estado</th>
            <th>Creación</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithRedirect,
      getRedirectResult,
      GoogleAuthProvider,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      updateDoc,
      getDoc,
      setDoc,
      arrayUnion,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
  apiKey: "AIzaSyDz0gGjx6Rw01MJ-s4hZC5DwYuGymeOL44",
  authDomain: "acuarela-e4613.firebaseapp.com",
  projectId: "acuarela-e4613",
  storageBucket: "acuarela-e4613.firebasestorage.app",
  messagingSenderId: "319613648205",
  appId: "1:319613648205:web:f693e3f4e1b9abd4aa0b04",
  measurementId: "G-KMJW7RZRTT"
};

    const ADMIN_UID = "cOwdzdTzzkWXQCJDrDU8bV3Xmev1";
    const COURSE_ID = "VCFE0H5Yj31YRL1UyF85";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const adminInfo = document.getElementById("adminInfo");
    const ordersBody = document.getElementById("ordersBody");
    const btnReload = document.getElementById("btnReload");
    const btnLogout = document.getElementById("btnLogout");

    getRedirectResult(auth)
      .then((result) => {
        if (result) {
          location.reload();
        }
      })
      .catch((error) => {
        console.error("Error en login redirect:", error);
      });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        adminInfo.className = "alert alert-warning small";
        adminInfo.innerHTML = `
          Debes iniciar sesión como administrador para continuar.
          <button id="btnLogin" class="btn btn-sm btn-primary ms-2">Iniciar con Google</button>
        `;
        document.getElementById("btnLogin").onclick = () => {
          signInWithRedirect(auth, provider);
        };
        btnReload.classList.add("d-none");
        btnLogout.classList.add("d-none");
        ordersBody.innerHTML = "";
        return;
      }

      if (user.uid !== ADMIN_UID) {
        adminInfo.className = "alert alert-danger small";
        adminInfo.textContent = "Acceso denegado: no eres administrador.";
        btnReload.classList.add("d-none");
        btnLogout.classList.add("d-none");
        ordersBody.innerHTML = "";
        return;
      }

      adminInfo.className = "alert alert-success small";
      adminInfo.textContent = `Admin conectado: ${user.email}`;
      btnReload.classList.remove("d-none");
      btnLogout.classList.remove("d-none");

      await loadOrders();
    });

    btnReload.addEventListener("click", loadOrders);

    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
      location.reload();
    });

    async function loadOrders() {
      ordersBody.innerHTML = `<tr><td colspan="8" class="text-muted">Cargando…</td></tr>`;
      try {
        const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        if (snap.empty) {
          ordersBody.innerHTML = `<tr><td colspan="8" class="text-muted">Sin órdenes</td></tr>`;
          return;
        }
        const rows = [];
        snap.forEach((docSnap) => {
          const o = docSnap.data();
          rows.push(`
            <tr data-id="${docSnap.id}" data-uid="${o.uid}" data-course="${o.courseId}">
              <td class="small">${docSnap.id}</td>
              <td class="small">${o.email || o.uid}</td>
              <td>${o.courseName || "-"}</td>
              <td>CLP $${Number(o.price || 0).toLocaleString("es-CL")}</td>
              <td>${o.receiptUrl ? `<a href="${o.receiptUrl}" target="_blank">Ver</a>` : "-"}</td>
              <td>
                <span class="badge bg-${
                  o.status === "approved"
                    ? "success"
                    : o.status === "rejected"
                    ? "danger"
                    : "warning"
                }">
                  ${o.status || "pending"}
                </span>
              </td>
              <td class="small">${
                o.createdAt?.toDate
                  ? o.createdAt.toDate().toLocaleString()
                  : "-"
              }</td>
              <td class="d-flex gap-2">
                <button class="btn btn-success btn-sm btn-approve">Aprobar</button>
                <button class="btn btn-danger btn-sm btn-reject">Rechazar</button>
              </td>
            </tr>
          `);
        });
        ordersBody.innerHTML = rows.join("");

        ordersBody.querySelectorAll(".btn-approve").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const tr = btn.closest("tr");
            await approveOrder(tr.dataset.id, tr.dataset.uid, tr.dataset.course);
            tr.querySelector(".badge").className = "badge bg-success";
            tr.querySelector(".badge").textContent = "approved";
          });
        });

        ordersBody.querySelectorAll(".btn-reject").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const tr = btn.closest("tr");
            await updateDoc(doc(db, "orders", tr.dataset.id), { status: "rejected" });
            tr.querySelector(".badge").className = "badge bg-danger";
            tr.querySelector(".badge").textContent = "rejected";
          });
        });
      } catch (e) {
        ordersBody.innerHTML = `<tr><td colspan="8" class="text-danger">Error cargando órdenes: ${e.message}</td></tr>`;
      }
    }

    async function approveOrder(orderId, uid, courseIdInOrder) {
      const targetCourseId = courseIdInOrder || COURSE_ID;
      try {
        await updateDoc(doc(db, "orders", orderId), { status: "approved" });

        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          await updateDoc(userRef, { accessCourses: arrayUnion(targetCourseId) });
        } else {
          await setDoc(userRef, { accessCourses: [targetCourseId] });
        }

        alert(`Orden aprobada y acceso otorgado (${targetCourseId}).`);
      } catch (e) {
        alert("Error al aprobar orden: " + e.message);
      }
    }
  </script>
</body>
</html>
